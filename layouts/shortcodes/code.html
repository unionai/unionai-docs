{{- /* This shortcode is used to render code blocks with line numbers and highlighting. */ -}}
{{- /* It takes the following parameters: */ -}}
{{- /* - file: The path to the file to be rendered. */ -}}
{{- /* - lang: The language of the code block. */ -}}
{{- /* - from: The starting line number of the code block. */ -}}
{{- /* - to: The ending line number of the code block. */ -}}
{{- /* - fragment: The fragment identifier to extract code between markers. */ -}}
{{- /* - show_fragments: Whether to show fragments in the code block. */ -}}
{{- /* Example usage: */ -}}
{{- /*     {{< code file="path/to/file" lang="html" from="1" to="5" fragment="my-fragment" >}} */ -}}

{{- $fileName := .Get "file" -}}
{{- $fragment := .Get "fragment" -}}
{{- $showFragments := .Params.show_fragments -}}

{{- /* Define allowed prefixes */ -}}
{{- $allowedPrefixes := slice "/static/" "/assets/" "/_static/" "/external/" -}}
{{- $isAllowed := false -}}

{{- /* Check if fileName has an allowed prefix */ -}}
{{- range $prefix := $allowedPrefixes -}}
  {{- if hasPrefix $fileName $prefix -}}
    {{- $isAllowed = true -}}
  {{- end -}}
{{- end -}}

{{- /* Fail if fileName doesn't have an allowed prefix */ -}}
{{- if not $isAllowed -}}
  {{- $callingFile := .Page.File.Path -}}
  {{- errorf "File path must start with one of the allowed prefixes: %s. Got: %s (called from: %s)" (delimit $allowedPrefixes ", ") $fileName $callingFile -}}
{{- end -}}

{{- $file := $fileName | readFile -}}
{{- $lang := .Get "lang" -}}

{{- $lineStart := .Get "from" -}}
{{- $lineEnd := .Get "to" -}}
{{- $highlight := .Get "highlight" -}}

{{- /* Extract filename and construct GitHub URL */ -}}
{{- $filename := path.Base $fileName -}}
{{- $githubURL := "" -}}
{{- if hasPrefix $fileName "/external/unionai-examples/" -}}
  {{- $relativePath := strings.TrimPrefix "/external/unionai-examples/" $fileName -}}
  {{- $githubURL = printf "https://github.com/unionai/unionai-examples/blob/main/%s" $relativePath -}}
{{- end -}}

{{- $lines := split $file "\n" -}}
{{- $filteredLines := slice -}}

{{- /* Handle fragment if specified */ -}}
{{- if $fragment -}}
  {{- $startMarker := printf "{{docs-fragment %s}}" $fragment -}}
  {{- $endMarker := printf "{{/docs-fragment %s}}" $fragment -}}
  {{- $foundStart := false -}}
  {{- $foundEnd := false -}}
  {{- range $lines -}}
    {{- $lineClean := replaceRE `^\s*(#|//|/\*+|\*+)?\s*` "" . -}}
    {{- if eq $lineClean $startMarker -}}
      {{- $foundStart = true -}}
    {{- else if eq $lineClean $endMarker -}}
      {{- $foundEnd = true -}}
    {{- else if and $foundStart (not $foundEnd) -}}
      {{- $filteredLines = $filteredLines | append . -}}
    {{- end -}}
  {{- end -}}
  {{- if not $foundStart -}}
    {{- warnf "Fragment marker '%s' not found in file %s. Please mark a section with the following markers: %s and %s"
          $fragment $fileName (printf "{{docs-fragment %s}}" $fragment) (printf "{{/docs-fragment %s}}" $fragment) -}}
    <div style="border: 2px dashed red; color: red; padding: 0.5rem 1rem; margin-bottom: 1rem;">
      Fragment marker '{{$fragment}}' not found in file {{$fileName}}. Please mark a section with the following markers:
      <code>{{ "{{docs-fragment " }}{{ $fragment }}{{ "}}" }}</code> and <code>{{ "{{/docs-fragment}}" }}</code>
    </div>
  {{- end -}}
{{- else if and $lineStart $lineEnd -}}
  {{- $start := int $lineStart -}}
  {{- $end := int $lineEnd -}}
  {{- $filteredLines = first (add (sub $end $start) 1) (after (sub $start 1) $lines) -}}
{{- else -}}
  {{- $filteredLines = $lines -}}
{{- end -}}

{{/* Prepare content with line numbers and highlighting */}}
{{- $content := "" -}}
{{- range $index, $line := $filteredLines -}}
  {{- if and (in $line "docs-fragment") (not $showFragments) -}}
    {{- continue -}}
  {{- end -}}
  {{- $content = print $content $line "\n" -}}
{{- end -}}

{{/* Generate the same HTML structure as render-codeblock.html, but with external file content */}}
{{- $suffix := "" -}}
{{- if $fragment -}}
    {{- $suffix = $fragment -}}
{{- else if and $lineStart $lineEnd -}}
    {{- $suffix = printf "%s-%s" $lineStart $lineEnd -}}
{{- else -}}
    {{- $suffix = "full" -}}
{{- end -}}
{{- $uniqueID := printf "code-%s-%s" (md5 $fileName) $suffix -}}

{{/* Build highlight options */}}
{{- $highlightOptions := "linenos=false" -}}
{{- if $highlight -}}
    {{- $highlightOptions = printf "linenos=false,hl_lines=%s" $highlight -}}
{{- end -}}

{{/* Generate the complete codeblock HTML structure */}}
<div class="codeblock">
    {{/* Title bar with filename, GitHub link, and copy button */}}
    <div class="codeblock-header">
        <span class="codeblock-filename">{{ $filename }}</span>
        <div class="codeblock-actions">
            {{- if hasPrefix $fileName "/external/unionai-examples/" -}}
            <a href="{{ $githubURL }}" target="_blank" rel="noopener" class="codeblock-github-link" title="View source on GitHub">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                </svg>
            </a>
            {{- end -}}
            <div class="copy">
                <sl-copy-button from="{{- $uniqueID -}}"></sl-copy-button>
            </div>
        </div>
    </div>
    <div id="{{- $uniqueID -}}" class="code">
        {{- highlight $content $lang $highlightOptions -}}
    </div>
</div>