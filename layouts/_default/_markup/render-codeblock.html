{{- /* For Python code, pre-process with markers before highlighting */ -}}
{{- $autolinkResult := partial "autolink-python.html" (dict "code" .Inner "lang" .Type) -}}
{{- $codeToHighlight := $autolinkResult.code -}}
{{- $linkMap := $autolinkResult.linkMap -}}

{{- /* Create a modified context for highlighting if we replaced anything */ -}}
{{- $highlightContext := . -}}
{{- if ne $codeToHighlight .Inner -}}
    {{- /* We need to pass the modified code to the highlighter */ -}}
    {{- /* Hugo doesn't allow modifying the context, so we use a workaround */ -}}
    {{- /* Preserve highlight options (like hl_lines) from the original code fence */ -}}
    {{- $opts := .Options | default dict -}}
    {{- $highlighted := transform.Highlight $codeToHighlight .Type $opts -}}
    {{- /* Rename language-* classes to syntax-* to prevent 1Password prism.js interference */ -}}
    {{- /* Handle both single class and multiple classes: class="language-python" or class="highlight language-python" */ -}}
    {{- $processedHTML := replaceRE `class="([^"]*\s)?language-([^"]+)"` `class="$1syntax-$2"` $highlighted -}}
    {{- $processedHTML = replaceRE `class="([^"]*\s)?lang-([^"]+)"` `class="$1syntax-$2"` $processedHTML -}}
    {{- /* Also rename data-lang attributes */ -}}
    {{- $processedHTML = replaceRE `data-lang="([^"]+)"` `data-syntax="$1"` $processedHTML -}}

    {{- /* Replace markers with actual links */ -}}
    {{- /* Extract base path from baseURL (e.g., http://localhost/dev/site/p/ -> /dev/site/p/) */ -}}
    {{- $basePath := "" -}}
    {{- with site.BaseURL -}}
        {{- $parsed := urls.Parse . -}}
        {{- $basePath = $parsed.Path -}}
        {{- $basePath = strings.TrimSuffix "/" $basePath -}}
    {{- end -}}
    {{- range $marker, $data := $linkMap -}}
        {{- /* Prepend base path to URL */ -}}
        {{- $fullURL := printf "%s%s" $basePath $data.url -}}
        {{- if $data.dotted -}}
            {{- /* For dotted identifiers, we want to link the whole thing as one clickable unit */ -}}
            {{- $link := printf `<a href="%s">%s</a>` $fullURL $data.text -}}
            {{- $processedHTML = replace $processedHTML $marker $link -}}
        {{- else -}}
            {{- /* Simple replacement */ -}}
            {{- $link := printf `<a href="%s">%s</a>` $fullURL $data.text -}}
            {{- $processedHTML = replace $processedHTML $marker $link -}}
        {{- end -}}
    {{- end -}}

    {{- $uniqueID := printf "code-%s-%d" (sha1 .Inner) .Ordinal -}}

    <div class="codeblock">
        <div class="copy">
            <sl-copy-button from="{{- $uniqueID -}}"></sl-copy-button>
        </div>
        <div id="{{- $uniqueID -}}" class="code" data-1p-ignore="true" data-bwignore="true" data-lastpass-ignore="true" autocomplete="off" contenteditable="false">{{ $processedHTML | safeHTML }}</div>
    </div>
{{- else -}}
    {{- /* No modifications, use normal highlighting */ -}}
    {{- $result := transform.HighlightCodeBlock . -}}
    {{- /* Rename language-* classes to syntax-* to prevent 1Password prism.js interference */ -}}
    {{- /* Handle both single class and multiple classes: class="language-python" or class="highlight language-python" */ -}}
    {{- $wrapped := replaceRE `class="([^"]*\s)?language-([^"]+)"` `class="$1syntax-$2"` $result.Wrapped -}}
    {{- $wrapped = replaceRE `class="([^"]*\s)?lang-([^"]+)"` `class="$1syntax-$2"` $wrapped -}}
    {{- /* Also rename data-lang attributes */ -}}
    {{- $wrapped = replaceRE `data-lang="([^"]+)"` `data-syntax="$1"` $wrapped -}}
    {{- $uniqueID := printf "code-%s-%d" (sha1 .Inner) .Ordinal -}}

    <div class="codeblock">
        <div class="copy">
            <sl-copy-button from="{{- $uniqueID -}}"></sl-copy-button>
        </div>
        <div id="{{- $uniqueID -}}" class="code" data-1p-ignore="true" data-bwignore="true" data-lastpass-ignore="true" autocomplete="off" contenteditable="false">{{ $wrapped | safeHTML }}</div>
    </div>
{{- end -}}
