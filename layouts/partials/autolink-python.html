{{- /* Partial template for Python code autolinking */ -}}
{{- /* Input: .code (the code to process), .lang (the language) */ -}}
{{- /* Output: dict with "html" (processed HTML) and "modified" (boolean) */ -}}

{{- $codeToHighlight := .code -}}
{{- $lang := .lang -}}
{{- $linkMap := dict -}}
{{- $modified := false -}}

{{- if eq $lang "python" -}}
    {{- /* Load and merge all API data sources from params.api_linkmap_sources */ -}}
    {{- $flyteapi := dict "identifiers" (dict) "methods" (dict) "packages" (dict) -}}
    {{- $sources := site.Params.api_linkmap_sources | default slice -}}
    {{- range $i, $sourceName := $sources -}}
        {{- with index site.Data $sourceName -}}
            {{- if eq $i 0 -}}
                {{- $flyteapi = merge $flyteapi (dict "identifiers" (.identifiers | default dict) "methods" (.methods | default dict) "packages" (.packages | default dict)) -}}
            {{- else -}}
                {{- $flyteapi = merge $flyteapi (dict "identifiers" (merge $flyteapi.identifiers (.identifiers | default dict)) "methods" (merge $flyteapi.methods (.methods | default dict)) "packages" (merge $flyteapi.packages (.packages | default dict))) -}}
            {{- end -}}
        {{- end -}}
    {{- end -}}

    {{- /* First, protect strings by replacing them with markers */ -}}
    {{- $stringMap := dict -}}
    {{- $stringCounter := 0 -}}

    {{- /* Replace triple-quoted strings first */ -}}
    {{- range $match := findRE `"""[\s\S]*?"""` $codeToHighlight -}}
        {{- $stringMarker := printf "___STRING_%d___" $stringCounter -}}
        {{- $stringMap = merge $stringMap (dict $stringMarker $match) -}}
        {{- $codeToHighlight = replace $codeToHighlight $match $stringMarker -}}
        {{- $stringCounter = add $stringCounter 1 -}}
    {{- end -}}
    {{- range $match := findRE `'''[\s\S]*?'''` $codeToHighlight -}}
        {{- $stringMarker := printf "___STRING_%d___" $stringCounter -}}
        {{- $stringMap = merge $stringMap (dict $stringMarker $match) -}}
        {{- $codeToHighlight = replace $codeToHighlight $match $stringMarker -}}
        {{- $stringCounter = add $stringCounter 1 -}}
    {{- end -}}

    {{- /* Replace single-line strings */ -}}
    {{- range $match := findRE `"[^"\n]*"` $codeToHighlight -}}
        {{- $stringMarker := printf "___STRING_%d___" $stringCounter -}}
        {{- $stringMap = merge $stringMap (dict $stringMarker $match) -}}
        {{- $codeToHighlight = replace $codeToHighlight $match $stringMarker -}}
        {{- $stringCounter = add $stringCounter 1 -}}
    {{- end -}}
    {{- range $match := findRE `'[^'\n]*'` $codeToHighlight -}}
        {{- $stringMarker := printf "___STRING_%d___" $stringCounter -}}
        {{- $stringMap = merge $stringMap (dict $stringMarker $match) -}}
        {{- $codeToHighlight = replace $codeToHighlight $match $stringMarker -}}
        {{- $stringCounter = add $stringCounter 1 -}}
    {{- end -}}

    {{- /* Build a combined list of all terms */ -}}
    {{- $allTerms := slice -}}

    {{- range $identifier, $path := $flyteapi.identifiers -}}
        {{- $allTerms = $allTerms | append (dict "term" $identifier "url" $path "len" (len $identifier) "type" "identifier") -}}
    {{- end -}}

    {{- range $package, $path := $flyteapi.packages -}}
        {{- $allTerms = $allTerms | append (dict "term" $package "url" $path "len" (len $package) "type" "package") -}}
    {{- end -}}

    {{- range $method, $path := $flyteapi.methods -}}
        {{- $allTerms = $allTerms | append (dict "term" $method "url" $path "len" (len $method) "type" "method") -}}
    {{- end -}}

    {{- /* Sort by length (longest first) */ -}}
    {{- $sortedTerms := sort $allTerms "len" "desc" -}}

    {{- /* Replace terms with unique markers */ -}}
    {{- $counter := 0 -}}
    {{- range $sortedTerms -}}
        {{- $term := .term -}}
        {{- $url := .url -}}
        {{- $termType := .type -}}

        {{- $marker := printf "___LINK_%d___" $counter -}}
        {{- $linkMap = merge $linkMap (dict $marker (dict "text" $term "url" $url)) -}}

        {{- if eq $termType "identifier" -}}
            {{- $parts := split $term "." -}}

            {{- if gt (len $parts) 1 -}}
                {{- $lastPart := index $parts (sub (len $parts) 1) -}}
                {{- $pkgPart := delimit (first (sub (len $parts) 1) $parts) "." -}}

                {{- $escapedPkg := replace $pkgPart "." "\\." -}}
                {{- $importCheckPattern := printf `from\s+%s\s+import\s+(?:[^,\n]+,\s*)*%s\b` $escapedPkg $lastPart -}}
                {{- $hasImport := findRE $importCheckPattern $codeToHighlight 1 -}}

                {{- if $hasImport -}}
                    {{- $symbolMarker := printf "___LINKSYM_%d___" $counter -}}
                    {{- $linkMap = merge $linkMap (dict $symbolMarker (dict "text" $lastPart "url" $url)) -}}

                    {{- $fromPattern := printf `(from\s+%s\s+import\s+(?:[^,\n]+,\s*)*)(%s)\b` $escapedPkg $lastPart -}}
                    {{- $codeToHighlight = replaceRE $fromPattern (printf `${1}%s` $symbolMarker) $codeToHighlight -}}

                    {{- $standalonePattern := printf `(?m)^([^#\n]*)\b(%s)\b` $lastPart -}}
                    {{- $codeToHighlight = replaceRE $standalonePattern (printf `${1}%s` $symbolMarker) $codeToHighlight -}}
                {{- end -}}

                {{- $escapedTerm := replace $term "." "\\." -}}
                {{- $pattern := printf `(?m)^([^#\n]*)\b(%s)\b` $escapedTerm -}}
                {{- $dottedMarker := printf "___LINKDOT_%d___" $counter -}}
                {{- $linkMap = merge $linkMap (dict $dottedMarker (dict "text" $term "url" $url "dotted" true)) -}}
                {{- $codeToHighlight = replaceRE $pattern (printf `${1}%s` $dottedMarker) $codeToHighlight -}}
            {{- else -}}
                {{- $pattern := printf `(?m)^([^#\n]*)\b(%s)\b` $term -}}
                {{- $codeToHighlight = replaceRE $pattern (printf `${1}%s` $marker) $codeToHighlight -}}
            {{- end -}}
        {{- else if eq $termType "method" -}}
            {{- $pattern := printf `(?m)^([^#\n]*)\b(%s)(\()` $term -}}
            {{- $codeToHighlight = replaceRE $pattern (printf `${1}%s${3}` $marker) $codeToHighlight -}}
        {{- else -}}
            {{- $pattern := printf `(?m)^([^#\n]*)\b(%s)\b` $term -}}
            {{- $codeToHighlight = replaceRE $pattern (printf `${1}%s` $marker) $codeToHighlight -}}
        {{- end -}}

        {{- $counter = add $counter 1 -}}
    {{- end -}}

    {{- /* Restore strings before highlighting */ -}}
    {{- range $marker, $originalString := $stringMap -}}
        {{- $codeToHighlight = replace $codeToHighlight $marker $originalString -}}
    {{- end -}}

    {{- $modified = ne $codeToHighlight .code -}}
{{- end -}}

{{- /* Return result as a dict */ -}}
{{- return (dict "code" $codeToHighlight "linkMap" $linkMap "modified" $modified) -}}
