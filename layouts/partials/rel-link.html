{{- $target := . }}
{{- $hasShortcode := hasPrefix $target "HAHAHUGOSHORTCODE" -}}
{{- $link := $target }}
{{/* If a shortcode starts the link, use it AS IS */}}
{{- if or $hasShortcode (hasPrefix $target "http://") (hasPrefix $target "https://") (hasPrefix $target "mailto:") -}}
    {{/* do nothing */}}
{{- else if or (in page.RelPermalink "/api-reference/") -}}
    {{/* do nothing */}}
{{- else -}}
    {{/* 1. Extract fragment FIRST, before any suffix trimming */}}
    {{ $fragment := "" }}
    {{ $path := $target }}
    {{ if (in $target "#") }}
        {{ $parts := split $target "#" }}
        {{ $path = index $parts 0 }}
        {{ $fragment = printf "#%s" (index $parts 1) }}
    {{ end }}

    {{/* 2. Trim .md suffix and detect _index references */}}
    {{ $path = strings.TrimSuffix ".md" $path }}
    {{ $isIndexRef := false }}
    {{ if or (eq $path "_index") (hasSuffix $path "/_index") }}
        {{ $isIndexRef = true }}
        {{ $path = strings.TrimSuffix "_index" $path }}
        {{ $path = strings.TrimSuffix "/" $path }}
    {{ end }}

    {{/* 3. Handle different path types */}}
    {{- if or (hasPrefix $path "/") (hasPrefix $path "http") -}}
        {{/* Absolute paths and URLs - use as-is */}}
        {{- $link = printf "%s%s" $path $fragment -}}
    {{- else if and (eq $path "") (not $isIndexRef) -}}
        {{/* Pure fragment like "#foo" - link to current page */}}
        {{- $link = printf "%s%s" page.RelPermalink $fragment -}}
    {{- else if and (not $isIndexRef) (or (eq $path ".") (eq $path "./")) -}}
        {{/* Explicit current page: ".#foo" or "./#foo" - link to current page */}}
        {{- $link = printf "%s%s" page.RelPermalink $fragment -}}
    {{- else if (hasSuffix page "_index.md") -}}
        {{/* From index page - relative to current directory */}}
        {{- $link = printf "%s%s%s" page.RelPermalink $path $fragment -}}
    {{- else -}}
        {{/* From non-index page - go up one level first */}}
        {{- $link = printf "%s../%s%s" page.RelPermalink $path $fragment -}}
    {{- end -}}
{{- end -}}
{{- return $link -}}
