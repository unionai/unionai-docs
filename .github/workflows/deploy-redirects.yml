name: Deploy Redirects

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths: ['infra']

jobs:
  deploy-redirects:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          submodules: 'true'
          fetch-depth: 2  # Need previous commit to detect submodule changes

      - name: Check if redirects.csv changed
        id: check-redirects
        run: |
          # For workflow_dispatch, always deploy
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
            echo "Manual trigger, proceeding with deploy."
            exit 0
          fi
          # For push events, check if the infra submodule ref changed and
          # whether that change includes redirects.csv
          OLD_REF=$(git diff HEAD~1 HEAD -- infra | grep "^-Subproject" | awk '{print $3}' || true)
          NEW_REF=$(git diff HEAD~1 HEAD -- infra | grep "^+Subproject" | awk '{print $3}' || true)
          if [ -z "$OLD_REF" ] || [ -z "$NEW_REF" ]; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
            echo "No submodule ref change detected, skipping."
            exit 0
          fi
          if git -C infra diff --name-only "$OLD_REF" "$NEW_REF" | grep -q "^redirects.csv$"; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
            echo "redirects.csv changed, proceeding with deploy."
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
            echo "redirects.csv unchanged, skipping deploy."
          fi

      - name: Set up Python
        if: steps.check-redirects.outputs.changed == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Deploy redirects to Cloudflare
        if: steps.check-redirects.outputs.changed == 'true'
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_LIST_ID: ${{ secrets.CLOUDFLARE_LIST_ID }}
        run: python3 infra/tools/redirect_generator/deploy_redirects.py
