name: Clean up PR Preview

on:
  pull_request:
    types: [closed]
    branches:
      - main
      - v1

jobs:
  cleanup-preview:
    runs-on: ubuntu-latest
    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install wrangler
        run: npm install -g wrangler

      - name: Create preview environment name
        id: preview
        run: |
          PREVIEW_NAME="pr-${{ github.event.number }}"
          echo "preview_name=$PREVIEW_NAME" >> $GITHUB_OUTPUT

      - name: Delete preview deployment
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          # Try to delete the preview deployment
          # This might fail if the deployment doesn't exist, which is OK
          wrangler pages deployment list --project-name=unionai-docs --compatibility-date=2024-01-01 | \
          grep "${{ steps.preview.outputs.preview_name }}" | \
          head -1 | \
          awk '{print $1}' | \
          xargs -r wrangler pages deployment delete --project-name=unionai-docs || true

      - name: Add cleanup comment
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.number }}
          body: |
            <!-- PR_CLEANUP_COMMENT -->
            ## ðŸ§¹ Preview Cleanup
            
            The preview environment for this PR has been cleaned up.
            
            <sub>ðŸ¤– Generated by GitHub Actions</sub>